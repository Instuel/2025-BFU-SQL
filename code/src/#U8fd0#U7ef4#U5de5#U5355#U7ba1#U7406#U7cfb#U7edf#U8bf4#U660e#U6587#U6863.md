# 运维工单管理系统说明文档

## 概述

本系统实现了完整的运维工单管理流程，包含告警审核、工单创建、派发、处理和审核等环节。系统支持两种主要角色：**运维工单管理员（DISPATCHER）** 和 **运维人员（OM）**，各自具有不同的权限和功能。

## 系统架构

### 角色权限设计

| 角色 | 角色标识 | 模块权限 | 主要职责 |
|------|----------|----------|----------|
| 运维工单管理员 | DISPATCHER | MODULE_DISPATCHER + MODULE_ALARM | 告警审核、工单创建派发、工单复查 |
| 运维人员 | OM | MODULE_ALARM | 工单处理、现场维修 |

### 数据库表结构

#### 核心表
- `Work_Order` - 运维工单主表
- `Alarm_Info` - 告警信息表
- `Alarm_Handling_Log` - 告警处理日志表
- `Role_Dispatcher` - 运维工单管理员角色表
- `Role_OandM` - 运维人员角色表

#### 关键字段
```sql
-- Work_Order 表
Order_ID BIGINT IDENTITY(1,1) PRIMARY KEY,
Alarm_ID BIGINT NOT NULL,
OandM_ID BIGINT NOT NULL,
Dispatcher_ID BIGINT NOT NULL,
Review_Status NVARCHAR(10), -- NULL(待审核)/通过/未通过
Review_Feedback NVARCHAR(500), -- 审核反馈
```

## 功能模块详解

### 1. 运维工单管理员（DISPATCHER）功能

#### 1.1 告警审核管理
**访问路径**: `/dispatcher?action=list`

**功能描述**:
- 查看所有待审核告警列表
- 对告警进行真实性审核（有效/误报）
- 统计高级告警和紧急处理数量

**操作流程**:
1. 登录系统，点击"运维工单管理"模块
2. 查看待审核告警列表
3. 点击告警详情，进行真实性审核
4. 选择审核结果：
   - **有效**: 进入工单创建流程
   - **误报**: 直接结案

#### 1.2 工单创建与派发
**访问路径**: `/dispatcher?action=createWorkOrder&alarmId={id}`

**功能描述**:
- 为有效告警创建运维工单
- 选择合适的运维人员进行派发
- 设置派单时间和说明

**操作流程**:
1. 审核告警为"有效"后，自动跳转到工单创建页面
2. 填写工单信息：
   - 选择运维人员
   - 设置派单时间（默认当前时间）
   - 添加派单说明
   - 上传相关附件
3. 点击"创建并派发工单"

**特殊处理**:
- 如果告警已存在工单，系统会更新现有工单而不是创建新工单
- 更新时会重置工单状态（responseTime=null, finishTime=null, reviewStatus=null）

#### 1.3 工单追踪与审核
**访问路径**: `/dispatcher?action=workOrderList`

**功能描述**:
- 查看所有工单状态
- 对完成的工单进行复查审核
- 统计工单处理情况

**操作流程**:
1. 点击"工单追踪"查看工单列表
2. 点击"审核"进入工单详情
3. 查看运维人员的处理结果
4. 进行复查审核：
   - **通过**: 工单完成，告警结案
   - **未通过**: 填写反馈意见，工单返回运维人员

### 2. 运维人员（OM）功能

#### 2.1 工单查看与接收
**访问路径**: `/alarm?action=workorderList`

**功能描述**:
- 查看分配给自己的工单
- 按状态筛选工单（待审核/通过/未通过）
- 查看工单详细信息

**权限限制**:
- 只能查看分配给自己的工单
- 无法查看其他运维人员的工单

#### 2.2 工单处理
**访问路径**: `/alarm?action=workorderDetail&id={orderId}`

**功能描述**:
- 查看工单详细信息和告警内容
- 填写处理过程和结果
- 上传现场照片或维修报告
- 提交工单等待审核

**操作流程**:
1. 点击工单进入详情页面
2. 查看告警信息和派单说明
3. 填写处理信息：
   - 响应时间（接单时间）
   - 完成时间（处理完成时间）
   - 处理结果描述
   - 上传附件（现场照片等）
4. 点击"提交工单"等待管理员审核

**权限限制**:
- 无法看到"重新派单"功能
- 只能处理分配给自己的工单

#### 2.3 复查未通过处理
**功能描述**:
- 查看管理员的审核反馈
- 根据反馈重新处理工单
- 重新提交审核

**操作流程**:
1. 收到"未通过"的工单
2. 查看管理员反馈意见
3. 根据反馈重新处理
4. 重新提交工单

## 系统配置

### 1. 数据库补丁执行

**必须执行** `sql/补丁.sql` 文件，包含以下重要修复：

```sql
-- 1. 添加 Review_Feedback 字段
ALTER TABLE dbo.Work_Order ADD Review_Feedback NVARCHAR(500) NULL;

-- 2. 扩展 Status_After 字段长度
ALTER TABLE dbo.Alarm_Handling_Log ALTER COLUMN Status_After NVARCHAR(200) NULL;

-- 3. 添加告警审核相关字段
ALTER TABLE dbo.Alarm_Info ADD Verify_Status NVARCHAR(10) NULL;
ALTER TABLE dbo.Alarm_Info ADD Verify_Remark NVARCHAR(200) NULL;
```

### 2. 权限配置

在数据库中为用户分配正确的模块权限：

```sql
-- 运维工单管理员权限
INSERT INTO User_Module_Permission (User_ID, Module_Code) VALUES 
({dispatcher_user_id}, 'MODULE_DISPATCHER'),
({dispatcher_user_id}, 'MODULE_ALARM');

-- 运维人员权限  
INSERT INTO User_Module_Permission (User_ID, Module_Code) VALUES 
({om_user_id}, 'MODULE_ALARM');
```

## 测试方法

### 1. 环境准备

#### 1.1 测试用户创建
```sql
-- 创建测试用户
INSERT INTO Sys_User (Login_Account, Password_Hash, Real_Name, Department, Account_Status) VALUES
('dispatcher_test', 'hashed_password', '测试调度员', '运维部', 1),
('om_test', 'hashed_password', '测试运维员', '运维部', 1);

-- 创建角色关联
INSERT INTO Role_Dispatcher (User_ID, Department) VALUES ({dispatcher_user_id}, '运维部');
INSERT INTO Role_OandM (User_ID, Department) VALUES ({om_user_id}, '运维部');
```

#### 1.2 测试数据准备
```sql
-- 创建测试告警
INSERT INTO Alarm_Info (Alarm_Type, Alarm_Level, Content, Occur_Time, Process_Status, Verify_Status, Ledger_ID) VALUES
('设备故障', '高', '变压器温度异常', GETDATE(), '未处理', '待审核', 1);
```

### 2. 功能测试流程

#### 2.1 运维工单管理员测试

**测试步骤**:
1. **登录测试**
   - 使用dispatcher_test账号登录
   - 验证能看到"运维工单管理"模块

2. **告警审核测试**
   ```
   访问: /dispatcher?action=list
   操作: 点击告警详情 → 选择"有效" → 提交审核
   预期: 跳转到工单创建页面
   ```

3. **工单创建测试**
   ```
   访问: /dispatcher?action=createWorkOrder&alarmId=1
   操作: 选择运维人员 → 填写说明 → 创建工单
   预期: 工单创建成功，状态为"待审核"
   ```

4. **工单审核测试**
   ```
   访问: /dispatcher?action=workOrderList
   操作: 点击"审核" → 选择"通过"/"未通过" → 提交
   预期: 工单状态更新，告警状态相应变化
   ```

#### 2.2 运维人员测试

**测试步骤**:
1. **登录测试**
   - 使用om_test账号登录
   - 验证只能看到"告警管理"模块

2. **工单查看测试**
   ```
   访问: /alarm?action=workorderList
   操作: 查看工单列表
   预期: 只显示分配给当前用户的工单
   ```

3. **工单处理测试**
   ```
   访问: /alarm?action=workorderDetail&id=1
   操作: 填写处理结果 → 上传附件 → 提交工单
   预期: 工单状态变为"待审核"
   ```

4. **权限验证测试**
   ```
   验证: 工单详情页面不显示"重新派单"按钮
   验证: 无法访问 /dispatcher 路径
   ```

### 3. 异常情况测试

#### 3.1 数据完整性测试
- 测试重复创建工单（应该更新现有工单）
- 测试无效告警创建工单（应该报错）
- 测试跨用户访问工单（应该被拒绝）

#### 3.2 权限边界测试
- OM用户尝试访问dispatcher功能
- 未登录用户访问受保护页面
- 不同角色间的数据隔离

### 4. 性能测试

#### 4.1 数据量测试
```sql
-- 创建大量测试数据
INSERT INTO Alarm_Info (...) VALUES (...); -- 1000条告警
INSERT INTO Work_Order (...) VALUES (...); -- 500个工单
```

#### 4.2 并发测试
- 多个dispatcher同时审核告警
- 多个OM同时处理工单
- 数据库锁竞争测试

## 常见问题排查

### 1. 403权限错误
**原因**: 用户缺少模块权限或路径映射错误
**解决**: 检查User_Module_Permission表和AuthFilter配置

### 2. 数据库字段错误
**原因**: 未执行补丁脚本或字段长度不足
**解决**: 执行完整的sql/补丁.sql文件

### 3. 工单重复创建
**原因**: 告警已存在工单但系统未正确处理
**解决**: 检查createWorkOrder方法的重复处理逻辑

### 4. 审核状态异常
**原因**: reviewStatus字段值不符合CHECK约束
**解决**: 确保只使用null/"通过"/"未通过"三种状态

## 系统维护

### 1. 日志监控
- 监控Alarm_Handling_Log表的日志记录
- 定期清理过期的处理日志

### 2. 数据备份
- 定期备份Work_Order和Alarm_Info表
- 保留重要的审核记录和处理历史

### 3. 性能优化
- 为常用查询字段添加索引
- 定期分析查询性能并优化

---

**文档版本**: 1.0  
**最后更新**: 2025年1月  
**维护人员**: 系统开发团队